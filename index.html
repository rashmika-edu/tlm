<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            /* Optimized CSS Gradient - No external assets to load */
            background: #f8fafc;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,93%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,100%,90%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(210,100%,93%,1) 0, transparent 50%);
            height: 100vh;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .active-tab {
            background: white;
            color: #2563eb !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Faster loading skeleton effect */
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="flex flex-col md:flex-row p-0 md:p-6 gap-6">

    <div id="loader" class="fixed inset-0 z-[100] bg-white/40 backdrop-blur-md flex items-center justify-center transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-xs font-bold text-blue-600 tracking-widest uppercase">Fast Sync...</p>
        </div>
    </div>

    <nav class="glass-panel w-full md:w-72 rounded-none md:rounded-[2.5rem] flex flex-row md:flex-col p-4 md:p-8 z-50">
        <div class="hidden md:flex items-center gap-3 mb-10">
            <div class="bg-blue-600 p-2 rounded-xl text-white"><i data-lucide="zap"></i></div>
            <h1 class="font-bold text-xl tracking-tight">Admin OS</h1>
        </div>

        <div class="flex flex-1 md:flex-col gap-2">
            <button onclick="switchTab('overview')" id="btn-overview" class="tab-link flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 p-3 md:p-4 rounded-2xl text-slate-500 active-tab">
                <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="hidden md:inline font-bold">Hub</span>
            </button>
            <button onclick="switchTab('schools')" id="btn-schools" class="tab-link flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 p-3 md:p-4 rounded-2xl text-slate-500">
                <i data-lucide="school" class="w-5 h-5"></i><span class="hidden md:inline font-bold">Schools</span>
            </button>
            <button onclick="switchTab('users')" id="btn-users" class="tab-link flex-1 md:flex-none flex items-center justify-center md:justify-start gap-3 p-3 md:p-4 rounded-2xl text-slate-500">
                <i data-lucide="users" class="w-5 h-5"></i><span class="hidden md:inline font-bold">Staff</span>
            </button>
        </div>

        <button onclick="logout()" class="hidden md:flex mt-auto items-center justify-center gap-2 p-4 bg-slate-900 text-white rounded-2xl font-bold">
            <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
        </button>
    </nav>

    <main class="flex-1 glass-panel rounded-none md:rounded-[2.5rem] overflow-hidden flex flex-col">
        <header class="p-6 md:p-8 flex justify-between items-center border-b border-white/40 bg-white/20">
            <div>
                <h2 id="view-title" class="text-2xl font-black text-slate-800">System Hub</h2>
                <p id="view-subtitle" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Global Analytics</p>
            </div>
            <button onclick="openModal('school')" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-bold text-sm shadow-lg shadow-blue-500/20">
                Add Institution
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8" id="scroll-area">
            
            <div id="tab-overview" class="tab-view space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white/50 p-6 rounded-3xl border border-white">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Institutions</p>
                        <h3 class="text-4xl font-black text-slate-800" id="stat-schools">--</h3>
                    </div>
                    <div class="bg-white/50 p-6 rounded-3xl border border-white">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Total Users</p>
                        <h3 class="text-4xl font-black text-slate-800" id="stat-users">--</h3>
                    </div>
                    <div class="bg-blue-600 p-6 rounded-3xl text-white shadow-xl shadow-blue-500/20">
                        <p class="text-[10px] font-bold opacity-80 uppercase">Active Leaves</p>
                        <h3 class="text-4xl font-black" id="stat-leaves">--</h3>
                    </div>
                </div>

                <div class="bg-white/40 rounded-[2rem] p-6 border border-white">
                    <h4 class="text-xs font-bold text-slate-500 mb-4 uppercase">Recent Activity</h4>
                    <div id="activity-feed" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-schools" class="tab-view hidden grid grid-cols-1 md:grid-cols-2 gap-4"></div>

            <div id="tab-users" class="tab-view hidden space-y-3"></div>

        </div>
    </main>

    <div id="modal-school" class="hidden fixed inset-0 z-[100] bg-slate-900/20 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6">New School</h3>
            <form id="schoolForm" class="space-y-4">
                <input type="text" id="schName" placeholder="Name" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border border-slate-100">
                <input type="text" id="schCode" placeholder="Code (e.g. SC-101)" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border border-slate-100">
                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 font-bold text-slate-400">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold">Create</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SB_URL = "https://wlzzepbqdeotluxkrthd.supabase.co"; 
        const SB_KEY = "sb_publishable_61_5jXI4eiFLGbS6MXLPRA_lNFgmCbt"; 
        const _db = supabase.createClient(SB_URL, SB_KEY);

        let cache = { schools: [], users: [], leaves: [] };

        // Optimized Data Fetcher (Parallel Requests)
        async function loadData() {
            setLoading(true);
            try {
                const [schoolsRes, profilesRes, leavesRes] = await Promise.all([
                    _db.from('schools').select('id, name, school_code'),
                    _db.from('profiles').select('id, full_name, role, school_code'),
                    _db.from('leaves').select('id, status', { count: 'exact' }).eq('status', 'Pending')
                ]);

                cache.schools = schoolsRes.data || [];
                cache.users = profilesRes.data || [];
                cache.leaves = leavesRes.data || [];

                renderAll();
            } catch (e) {
                console.error("Fetch Error:", e);
            } finally {
                setLoading(false);
            }
        }

        function renderAll() {
            // Stats
            document.getElementById('stat-schools').innerText = cache.schools.length;
            document.getElementById('stat-users').innerText = cache.users.length;
            document.getElementById('stat-leaves').innerText = cache.leaves.length;

            // Activity (Top 5 Users)
            document.getElementById('activity-feed').innerHTML = cache.users.slice(0, 5).map(u => `
                <div class="flex items-center justify-between p-3 bg-white/50 rounded-xl border border-white/50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">${u.full_name[0]}</div>
                        <p class="text-xs font-bold text-slate-700">${u.full_name}</p>
                    </div>
                    <span class="text-[9px] font-bold text-slate-400 uppercase">${u.school_code}</span>
                </div>
            `).join('');

            // Schools Grid
            document.getElementById('tab-schools').innerHTML = cache.schools.map(s => `
                <div class="bg-white/50 p-6 rounded-3xl border border-white">
                    <h5 class="font-bold text-slate-800">${s.name}</h5>
                    <p class="text-[10px] font-bold text-blue-500 mt-1">${s.school_code}</p>
                </div>
            `).join('');

            // Users List
            document.getElementById('tab-users').innerHTML = cache.users.map(u => `
                <div class="bg-white/50 p-4 rounded-2xl flex justify-between items-center border border-white">
                    <div><p class="text-sm font-bold text-slate-800">${u.full_name}</p><p class="text-[10px] text-slate-400 font-bold uppercase">${u.role}</p></div>
                    <div class="text-right"><p class="text-[10px] font-bold text-slate-800">${u.school_code}</p></div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active-tab'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('btn-'+t).classList.add('active-tab');
            document.getElementById('view-title').innerText = t.charAt(0).toUpperCase() + t.slice(1);
        }

        function setLoading(s) { 
            const l = document.getElementById('loader');
            if(s) l.classList.remove('hidden'); else l.classList.add('hidden');
        }

        function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-school').classList.add('hidden'); }

        document.getElementById('schoolForm').onsubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            await _db.from('schools').insert([{ name: document.getElementById('schName').value, school_code: document.getElementById('schCode').value }]);
            closeModal();
            loadData();
        };

        window.onload = () => { loadData(); lucide.createIcons(); };
    </script>
</body>
</html>
