<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LankaTeacher | Secure Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,93%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, hsla(220,100%,90%,1) 0, transparent 50%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.05);
        }

        .tab-active {
            background: #2563eb;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        input:focus { border-color: #2563eb; ring: 2px #2563eb; }
    </style>
</head>
<body>

    <div id="auth-portal" class="w-full max-w-[440px] p-6">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter">LankaTeacher <span class="text-blue-600">Pro</span></h1>
            <p class="text-slate-500 text-sm font-medium mt-1">Institutional Management System</p>
        </div>

        <div class="glass-card rounded-[2.5rem] p-8">
            <div class="flex bg-slate-200/50 p-1.5 rounded-2xl mb-8">
                <button onclick="setAccess('teacher')" id="tab-teacher" class="flex-1 py-2.5 rounded-xl font-bold text-[11px] uppercase tracking-wider text-slate-500 transition-all tab-active">Teacher</button>
                <button onclick="setAccess('principal')" id="tab-principal" class="flex-1 py-2.5 rounded-xl font-bold text-[11px] uppercase tracking-wider text-slate-500 transition-all">Principal</button>
                <button onclick="setAccess('admin')" id="tab-admin" class="flex-1 py-2.5 rounded-xl font-bold text-[11px] uppercase tracking-wider text-slate-500 transition-all">System Admin</button>
            </div>

            <form id="loginForm" class="space-y-4">
                <div id="portal-badge" class="inline-block px-3 py-1 bg-blue-100 text-blue-600 text-[10px] font-black rounded-full mb-2 uppercase tracking-widest">Teacher Access</div>
                
                <div class="space-y-4" id="form-fields">
                    <input type="email" id="email" placeholder="Institutional Email" required class="w-full p-4 bg-white/50 border border-slate-200 rounded-2xl outline-none transition-all">
                    <input type="password" id="password" placeholder="Password" required class="w-full p-4 bg-white/50 border border-slate-200 rounded-2xl outline-none transition-all">
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-slate-800 active:scale-[0.98] transition-all mt-2">
                    Enter Dashboard
                </button>
            </form>

            <div id="reg-section" class="mt-6 text-center">
                <p class="text-sm text-slate-500">New teacher? 
                    <button onclick="showRegister()" class="text-blue-600 font-bold hover:underline">Create an account</button>
                </p>
            </div>
        </div>

        <p class="text-center mt-8 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Â© 2026 Developer by K.A.V.Rashmika</p>
    </div>

    <div id="reg-modal" class="hidden fixed inset-0 z-50 bg-slate-900/20 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl">
            <h3 class="text-2xl font-black text-slate-800 mb-2">Teacher Registration</h3>
            <p class="text-slate-500 text-sm mb-6">Join your school's digital network.</p>
            
            <form id="registerForm" class="space-y-4">
                <input type="text" id="regName" placeholder="Full Name" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <input type="email" id="regEmail" placeholder="Email Address" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <input type="password" id="regPass" placeholder="Create Password" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <input type="text" id="regCode" placeholder="School Access Code" required class="w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl outline-none">
                
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="hideRegister()" class="flex-1 font-bold text-slate-400">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20">Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SB_URL = "https://wlzzepbqdeotluxkrthd.supabase.co"; 
        const SB_KEY = "sb_publishable_61_5jXI4eiFLGbS6MXLPRA_lNFgmCbt"; 
        const _db = supabase.createClient(SB_URL, SB_KEY);

        let currentRole = 'teacher';

        // UI LOGIC
        function setAccess(role) {
            currentRole = role;
            
            // Update Tabs
            document.querySelectorAll('.flex button').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('tab-' + role).classList.add('tab-active');

            // Update Badge
            const badge = document.getElementById('portal-badge');
            badge.innerText = role + ' Access';
            badge.className = `inline-block px-3 py-1 text-[10px] font-black rounded-full mb-2 uppercase tracking-widest ${
                role === 'admin' ? 'bg-rose-100 text-rose-600' : 
                role === 'principal' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'
            }`;

            // Toggle Registration visibility
            document.getElementById('reg-section').classList.toggle('hidden', role !== 'teacher');
        }

        function showRegister() { document.getElementById('reg-modal').classList.remove('hidden'); }
        function hideRegister() { document.getElementById('reg-modal').classList.add('hidden'); }

        // AUTH LOGIC
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const { data, error } = await _db.auth.signInWithPassword({ email, password });

            if (error) {
                alert("Login Failed: " + error.message);
            } else {
                // Verify Role matches the selected tab
                const { data: profile } = await _db.from('profiles').select('role').eq('id', data.user.id).single();
                
                if (profile.role !== currentRole) {
                    alert(`Unauthorized. This account is registered as a ${profile.role}.`);
                    await _db.auth.signOut();
                } else {
                    alert(`Welcome, Authorized ${currentRole}. Redirecting...`);
                    // window.location.href = `/${currentRole}-dashboard.html`;
                }
            }
        };

        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            const code = document.getElementById('regCode').value;

            // 1. Check if School Code is valid
            const { data: school } = await _db.from('schools').select('school_code').eq('school_code', code).single();
            if (!school) {
                alert("Invalid School Access Code. Please contact your Principal.");
                return;
            }

            // 2. Auth Sign Up
            const { data, error } = await _db.auth.signUp({ email, password });
            if (error) {
                alert(error.message);
            } else {
                // 3. Create Profile as 'teacher'
                await _db.from('profiles').insert([{
                    id: data.user.id,
                    full_name: name,
                    role: 'teacher',
                    school_code: code
                }]);
                alert("Teacher account created! Please log in.");
                hideRegister();
            }
        };
    </script>
</body>
</html>
